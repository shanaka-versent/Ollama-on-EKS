name: Kong Config Sync

on:
  push:
    branches:
      - main
    paths:
      - 'deck/kong-config.yaml'

jobs:
  sync:
    name: Sync kong-config.yaml to Konnect
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install decK
        run: |
          curl -sL https://github.com/Kong/deck/releases/latest/download/deck_linux_amd64.tar.gz \
            | tar -xz -C /usr/local/bin deck

      - name: Validate config
        run: |
          deck gateway validate deck/kong-config.yaml \
            --konnect-addr https://${{ secrets.KONNECT_REGION }}.api.konghq.com \
            --konnect-token ${{ secrets.KONNECT_TOKEN }} \
            --konnect-control-plane-name ${{ secrets.KONNECT_CP_NAME }}

      - name: Diff (show what will change)
        run: |
          deck gateway diff deck/kong-config.yaml \
            --konnect-addr https://${{ secrets.KONNECT_REGION }}.api.konghq.com \
            --konnect-token ${{ secrets.KONNECT_TOKEN }} \
            --konnect-control-plane-name ${{ secrets.KONNECT_CP_NAME }}

      - name: Sync to Konnect
        run: |
          deck gateway sync deck/kong-config.yaml \
            --konnect-addr https://${{ secrets.KONNECT_REGION }}.api.konghq.com \
            --konnect-token ${{ secrets.KONNECT_TOKEN }} \
            --konnect-control-plane-name ${{ secrets.KONNECT_CP_NAME }}
