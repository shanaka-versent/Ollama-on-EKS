# Kong Konnect Cloud AI Gateway — Declarative Configuration (decK)
# @author Shanaka Jayasundera - shanakaj@gmail.com
#
# Configures Kong as an AI Gateway for Ollama LLM on EKS.
# Routes traffic from Kong Cloud Gateway through Transit Gateway to Ollama.
#
# Architecture:
#   Client --> Kong Cloud AI GW --[Transit GW]--> Internal NLB --> Istio Gateway --> Ollama
#
# IMPORTANT: Replace k8s-istioing-ollamaga-df71b1176c-0870f678b71f0450.elb.us-west-2.amazonaws.com with the Istio Gateway NLB DNS.
# Run ./scripts/04-post-setup.sh to auto-discover and replace.
#
# Apply:
#   deck gateway sync deck/kong.yaml \
#     --konnect-addr https://${KONNECT_REGION}.api.konghq.com \
#     --konnect-token $KONNECT_TOKEN \
#     --konnect-control-plane-name kong-cloud-gateway-eks

_format_version: "3.0"

# ==============================================================================
# SERVICES & ROUTES
# ==============================================================================
# All services point to the SINGLE Istio Gateway internal NLB.
# Kong sends traffic to this NLB, Istio routes to the Ollama pod.
#
# Replace k8s-istioing-ollamaga-df71b1176c-0870f678b71f0450.elb.us-west-2.amazonaws.com with the actual NLB hostname from:
#   kubectl get gateway -n istio-ingress ollama-gateway \
#     -o jsonpath='{.status.addresses[0].value}'

services:
  # --------------------------------------------------------------------------
  # Ollama Native API — Direct pass-through for Claude Code & Ollama CLI
  # --------------------------------------------------------------------------
  # Proxies all Ollama-native endpoints: /api/tags, /api/chat, /api/generate,
  # /v1/chat/completions (Ollama's built-in OpenAI compat), etc.
  #
  # Claude Code usage:
  #   source claude-switch.sh ollama --endpoint https://<KONG_PROXY_URL> --apikey <key>
  #   claude --model qwen3-coder:30b
  #
  # Direct curl usage:
  #   curl https://<KONG_PROXY_URL>/api/tags -H "apikey: <key>"
  #   curl https://<KONG_PROXY_URL>/v1/chat/completions \
  #     -H "apikey: <key>" -H "Content-Type: application/json" \
  #     -d '{"model":"qwen3-coder:30b","messages":[{"role":"user","content":"Hello"}]}'
  - name: ollama-direct
    url: http://k8s-istioing-ollamaga-df71b1176c-0870f678b71f0450.elb.us-west-2.amazonaws.com:80
    protocol: http
    port: 80
    routes:
      - name: ollama-api-route
        paths:
          - /api
          - /v1
        strip_path: false
        protocols:
          - https
          - http
    plugins:
      - name: rate-limiting
        config:
          minute: 60
          policy: local
          fault_tolerant: true
          hide_client_headers: false
      - name: request-transformer
        config:
          add:
            headers:
              - "X-Kong-Proxy: true"
              - "X-Request-Source: cloud-ai-gateway"

  # --------------------------------------------------------------------------
  # Health Check — verifies NLB connectivity from Kong Cloud Gateway
  # --------------------------------------------------------------------------
  - name: gateway-health
    url: http://k8s-istioing-ollamaga-df71b1176c-0870f678b71f0450.elb.us-west-2.amazonaws.com:80
    protocol: http
    port: 80
    routes:
      - name: health-route
        paths:
          - /healthz
        strip_path: false
        protocols:
          - https
          - http

# ==============================================================================
# CONSUMERS & CREDENTIALS
# ==============================================================================
# Add team members as consumers with API keys for access control.
#
# To add a new team member:
#   1. Add a consumer block below with a strong key
#   2. Sync: deck gateway sync deck/kong.yaml ...
#   3. Share the API key with the team member
#
# Usage:
#   curl https://<KONG_PROXY_URL>/api/tags -H "apikey: <key>"

consumers:
  - username: team-admin
    keyauth_credentials:
      - key: change-me-admin-key-do-not-use-in-production
  - username: team-dev
    keyauth_credentials:
      - key: change-me-dev-key-do-not-use-in-production

# ==============================================================================
# GLOBAL PLUGINS
# ==============================================================================
# These plugins apply to ALL routes.

plugins:
  # API Key Authentication — all routes require an API key
  - name: key-auth
    config:
      key_names:
        - apikey
        - x-api-key
      key_in_header: true
      key_in_query: true
      hide_credentials: true

  # Request size limit — protect against oversized prompts (10MB)
  - name: request-size-limiting
    config:
      allowed_payload_size: 10
      size_unit: megabytes
      require_content_length: false
